name: License Guard

on:
  push:
    branches: [main, develop]
    paths:
      - 'LICENSE'
      - '**/requirements*.txt'
      - '**/package*.json'
      - '**/pyproject.toml'
  pull_request:
    branches: [main]
    paths:
      - 'LICENSE'
      - '**/requirements*.txt'
      - '**/package*.json'
      - '**/pyproject.toml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  verify-license:
    name: Verify Repository License
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check LICENSE file exists
        run: |
          if [ ! -f LICENSE ]; then
            echo "::error::LICENSE file is missing!"
            exit 1
          fi
          
      - name: Verify Apache-2.0 License
        run: |
          # Check for Apache-2.0 license markers
          if ! grep -q "Apache License" LICENSE; then
            echo "::error::LICENSE file does not appear to be Apache-2.0"
            exit 1
          fi
          
          if ! grep -q "Version 2.0" LICENSE; then
            echo "::error::LICENSE file does not appear to be Apache-2.0 Version 2.0"
            exit 1
          fi
          
          echo "✅ LICENSE file verified as Apache-2.0"
          
      - name: Check LICENSE has not been modified
        run: |
          # Download canonical Apache-2.0 license
          curl -sL https://www.apache.org/licenses/LICENSE-2.0.txt -o apache-2.0-canonical.txt
          
          # Compare first significant line (skip potential whitespace differences)
          if ! grep -q "Apache License" LICENSE; then
            echo "::error::LICENSE does not contain Apache License header"
            exit 1
          fi
          
          echo "✅ LICENSE content verified"

  check-dependency-licenses:
    name: Check Dependency Licenses
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          
      - name: Install license checker
        run: |
          python -m pip install --upgrade pip
          pip install pip-licenses liccheck
          
      - name: Install project dependencies
        run: |
          pip install -r sentinel/requirements.txt || true
          pip install -r talon/requirements.txt || true
          pip install -r operations/requirements.txt || true
          pip install -r shared/requirements.txt || true
          
      - name: Generate license report
        run: |
          pip-licenses --format=markdown --output-file=licenses.md
          pip-licenses --format=json --output-file=licenses.json
          echo "## Dependency Licenses" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pip-licenses --format=markdown >> $GITHUB_STEP_SUMMARY
          
      - name: Check for forbidden licenses
        run: |
          # List of licenses incompatible with Apache-2.0
          FORBIDDEN_LICENSES=(
            "GPL-2.0"
            "GPL-3.0"
            "AGPL-3.0"
            "LGPL-2.0"
            "LGPL-2.1"
            "LGPL-3.0"
            "SSPL"
            "BUSL"
          )
          
          # Check for forbidden licenses
          FOUND_FORBIDDEN=0
          for license in "${FORBIDDEN_LICENSES[@]}"; do
            if pip-licenses --format=csv | grep -i "$license"; then
              echo "::warning::Found potentially incompatible license: $license"
              FOUND_FORBIDDEN=1
            fi
          done
          
          if [ $FOUND_FORBIDDEN -eq 1 ]; then
            echo "::warning::Some dependencies may have licenses incompatible with Apache-2.0. Review required."
          fi
          
      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            licenses.md
            licenses.json
          retention-days: 90

  license-headers:
    name: Check License Headers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Python files for license headers
        run: |
          # Define expected header pattern
          HEADER_PATTERN="Apache-2.0\|Apache License\|Licensed under the Apache"
          
          MISSING_HEADERS=0
          
          # Check Python files (excluding tests and __init__.py)
          for file in $(find . -name "*.py" -not -path "./.venv/*" -not -path "./tests/*" -not -name "__init__.py" -not -name "conftest.py"); do
            # Check first 20 lines for license reference
            if ! head -20 "$file" | grep -q "$HEADER_PATTERN"; then
              # Check if file has docstring that might contain license info
              if ! head -50 "$file" | grep -qi "license\|copyright"; then
                echo "::notice file=$file::May be missing license header"
                MISSING_HEADERS=$((MISSING_HEADERS + 1))
              fi
            fi
          done
          
          if [ $MISSING_HEADERS -gt 0 ]; then
            echo "::notice::$MISSING_HEADERS files may be missing license headers. Consider adding Apache-2.0 headers."
          else
            echo "✅ License headers check passed"
          fi

  summary:
    name: License Summary
    runs-on: ubuntu-latest
    needs: [verify-license, check-dependency-licenses, license-headers]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## License Guard Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository License | ${{ needs.verify-license.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Licenses | ${{ needs.check-dependency-licenses.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Headers | ${{ needs.license-headers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This project is licensed under **Apache-2.0**." >> $GITHUB_STEP_SUMMARY
